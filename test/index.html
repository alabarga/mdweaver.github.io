<!DOCTYPE html>
<html>
  <head>
    <title>Michael Weaver | Travel Time Map</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link rel="shortcut icon" href="https://dl.dropboxusercontent.com/u/8139153/favicon.ico" />
    <style>
      html, body, #map {
        height: 100%;
        padding: 0;
        margin: 0;
      }
      button {
         display: inline-block;
         padding: 10px 20px 10px 20px;
         background: #ff5a5f;
         border-radius: 3px;
         color: #eee;
         font-weight: 400;
         font-size: 90%;
         margin: 0px 5px 0px 5px;
         z-index: 100;
         position: absolute;
         top: 20px;
         right: 20px;
      }
      button.hidden{
        display: none;
      }
    </style>
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.12/themes/css/cartodb.css" />
    <!--[if lte IE 8]>
      <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.ie.css" />
    <![endif]-->
  </head>
  <body>
    <div id="map"></div>
        
    <!-- include cartodb.js library -->
    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.12/cartodb.js"></script>
    <div class="cartodb-overlay overlay-text desktop" style="z-index: 4; max-width: 500px; margin-left: 0px; margin-top: 0px; top: 0px; left: 1%; right: auto; bottom: auto; display: block; background-color: rgba(0, 0, 0, 0);">    <div class="content">    <div class="text widget_text" style="z-index: 4; color: rgb(0, 0, 0); text-align: left; font-size: 25px;"><strong>Travel time between counties: 1880</strong></div>    </div></div>

    <div class="cartodb-overlay overlay-text desktop" style="z-index: 4; max-width: 330px; margin-left: 0px; margin-top: 0px; top: 7%; left: 1%; right: auto; bottom: auto; display: block; background-color: rgba(0, 0, 0, 0);">    <div class="content">    <div class="text widget_text" style="z-index: 4; color: rgb(100, 100, 100); text-align: left; font-size: 12px;">This map presents shortest travel times between counties by land or railroad in 1880. <a href="http://www.banxico.org.mx/publicaciones-y-discursos/publicaciones/documentos-de-investigacion/banxico/%7B2F47889C-B853-8304-6300-AC74A75878A4%7D.pdf">Railroad data and method</a> for computing travel times come from <a href="https://sites.google.com/site/fdperezcervantes/">Fernando PÃ©rez-Cervantes</a>. </div> </div></div>

    <script>

      function main() {
        // Add your code here
        var map = new L.Map('map', { zoomControl: false, center: [39.833333, -98.583333], zoom: 4 });
        var layer = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png').addTo(map);


        var legend = new cdb.geo.ui.Legend({
           type: "choropleth",
           data: [{ value: "0 days"}, { value: "21+ days"},
             {name : 'color1', value: '#5E4FA2'},
{name : 'color2', value: '#4075B4'},
{name : 'color3', value: '#3990B9'},
{name : 'color4', value: '#48A0B2'},
{name : 'color5', value: '#56B1AB'},
{name : 'color6', value: '#65C1A5'},
{name : 'color7', value: '#72C7A4'},
{name : 'color8', value: '#80CCA4'},
{name : 'color9', value: '#8DD1A4'},
{name : 'color10', value: '#9AD6A4'},
{name : 'color11', value: '#A8DBA4'},
{name : 'color12', value: '#B1DFA2'},
{name : 'color13', value: '#BAE3A0'},
{name : 'color14', value: '#C3E69F'},
{name : 'color15', value: '#CCEA9D'},
{name : 'color16', value: '#D5EE9B'},
{name : 'color17', value: '#DEF199'},
{name : 'color18', value: '#E6F598'},
{name : 'color19', value: '#E9F69D'},
{name : 'color20', value: '#ECF7A2'},
{name : 'color21', value: '#EFF8A6'},
{name : 'color22', value: '#F2FAAB'},
{name : 'color23', value: '#F5FBB0'},
{name : 'color24', value: '#F8FCB5'},
{name : 'color25', value: '#FBFDBA'},
{name : 'color26', value: '#FEFEBE'},
{name : 'color27', value: '#FEFBB9'},
{name : 'color28', value: '#FEF8B3'},
{name : 'color29', value: '#FEF5AE'},
{name : 'color30', value: '#FEF1A8'},
{name : 'color31', value: '#FEEEA3'},
{name : 'color32', value: '#FEEB9D'},
{name : 'color33', value: '#FEE798'},
{name : 'color34', value: '#FEE492'},
{name : 'color35', value: '#FEE18C'},
{name : 'color36', value: '#FDDC88'},
{name : 'color37', value: '#FDD884'},
{name : 'color38', value: '#FDD380'},
{name : 'color39', value: '#FDCE7C'},
{name : 'color40', value: '#FDCA78'},
{name : 'color41', value: '#FDC574'},
{name : 'color42', value: '#FDC070'},
{name : 'color43', value: '#FDBC6C'},
{name : 'color44', value: '#FDB768'},
{name : 'color45', value: '#FDB264'},
{name : 'color46', value: '#FCAD60'},
{name : 'color47', value: '#FCA85E'},
{name : 'color48', value: '#FBA35B'},
{name : 'color49', value: '#FA9D59'},
{name : 'color50', value: '#F99856'},
{name : 'color51', value: '#F99254'},
{name : 'color52', value: '#F88D51'},
{name : 'color53', value: '#F7874F'},
{name : 'color54', value: '#F6824C'},
{name : 'color55', value: '#F67C4A'},
{name : 'color56', value: '#F57747'},
{name : 'color57', value: '#F47145'},
{name : 'color58', value: '#F36C43'},
{name : 'color59', value: '#F16844'},
{name : 'color60', value: '#EE6544'},
{name : 'color61', value: '#EC6145'},
{name : 'color62', value: '#EA5D46'},
{name : 'color63', value: '#E75A47'},
{name : 'color64', value: '#E55648'},
{name : 'color65', value: '#E25349'},
{name : 'color66', value: '#E04F4A'},
{name : 'color67', value: '#DE4B4B'},
{name : 'color68', value: '#DB484C'},
{name : 'color69', value: '#D9444D'},
{name : 'color70', value: '#D7414E'},
{name : 'color71', value: '#D43D4E'},
{name : 'color72', value: '#D0394D'},
{name : 'color73', value: '#CC344D'},
{name : 'color74', value: '#C8304C'},
{name : 'color75', value: '#C42C4B'},
{name : 'color76', value: '#C0274A'},
{name : 'color77', value: '#BD2349'},
{name : 'color78', value: '#B91F48'},
{name : 'color79', value: '#B51A47'},
{name : 'color80', value: '#B11646'},
{name : 'color81', value: '#AD1245'},
{name : 'color82', value: '#A90D44'},
{name : 'color83', value: '#A50943'},
{name : 'color84', value: '#A10542'},
{name : 'color85', value: '#9E0142'}
           ]
         });
         $('#map').append(legend.render().el);
        cartodb.createLayer(map, 'https://mdweaver107.cartodb.com/api/v2/viz/02510880-f0ed-11e4-a210-0e4fddd5de28/viz.json').addTo(map).on('done', function(layer) {
          var counties = layer.getSubLayer(0); 
          counties.setInteractivity('cartodb_id, fips, name, time')
          counties.setInteraction(true);

          counties.on('featureClick', function(e, pos, pixel, data) { 
              var newSql = "SELECT times_1880.* , round(t1.time,1) as time FROM times_1880, (SELECT generate_series(1,3109) as row_id,  unnest(distances)::numeric as time FROM times_1880 WHERE times_1880.fips = " + data.fips + ") as t1 Where times_1880.row_id = t1.row_id";
              counties.setSQL(newSql);
            });
           })
        map.render();
      }


      // you could use $(window).load(main);
      window.onload = main;
    </script>
  </body>
</html>